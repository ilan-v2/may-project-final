<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Chapter Video Player</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      width: 100vw;
      margin: 0;
    }
    #player {
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      display: block;
      background: #000;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div style="position: absolute; top: 20px; left: 0; width: 100vw; text-align: center; z-index: 10;">
    <span id="errorMsg" style="color: #ff5555; font-size: 1.2em; margin-left: 2em;"></span>
  </div>
  <video id="player" width="640" height="360" controls autoplay loop muted playsinline>
    <source id="videoSource" src="{{ default_video_path }}" type="video/mp4">
  </video>
  <!-- WS_PORT is injected by FastAPI template rendering -->
  <script>
    const player = document.getElementById('player');
    const videoSource = document.getElementById('videoSource');
    const chapterName = document.getElementById('chapterName');
    const errorMsg = document.getElementById('errorMsg');
    const wsPort = {{ ws_port }};
    const ws = new WebSocket(`ws://${location.hostname}:${wsPort}/ws`);
    ws.onopen = () => {
      console.log('WebSocket connection established');
    };
    ws.onerror = (error) => {
      errorMsg.textContent = 'WebSocket error';
      console.error('WebSocket error:', error);
    };
    ws.onclose = () => {
      errorMsg.textContent = 'WebSocket connection closed';
      console.log('WebSocket connection closed');
    };
    let currentIndex = null;
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.error) {
          errorMsg.textContent = data.error;
          chapterName.textContent = '';
          return;
        } else {
          errorMsg.textContent = '';
        }
        const idx = data.index;
        const path = data.path;
        const chapter = data.chapter;
        // log path
        console.log(`Received index: ${idx}, path: ${path}, chapter: ${chapter}`);
        if (typeof idx === 'number' && typeof path === 'string' && idx !== currentIndex) {
          currentIndex = idx;
          videoSource.src = path;
          player.load();
          player.play();
        }
      } catch (e) {
        errorMsg.textContent = 'Invalid message from server';
        console.error('Invalid message from server:', event.data);
      }
    };

    // Ensure video starts automatically on page load
    window.addEventListener('DOMContentLoaded', () => {
      player.muted = true; // Ensure autoplay works on all browsers
      player.play().catch(() => {});
    });

    // Unmute after first user interaction
    const unmuteOnUserGesture = () => {
      player.muted = false;
      window.removeEventListener('click', unmuteOnUserGesture);
      window.removeEventListener('keydown', unmuteOnUserGesture);
    };
    window.addEventListener('click', unmuteOnUserGesture);
    window.addEventListener('keydown', unmuteOnUserGesture);

    // Ensure video repeats itself if it reaches the end
    player.addEventListener('ended', () => {
      player.currentTime = 0;
      player.play();
    });
  </script>
</body>
</html>
